# æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆäºŒï¼‰- Hooks ä¹‹ useState å’Œ useReducer
---

å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

## 1. useState

useState å¯ä»¥è¯´æ˜¯ä½¿ç”¨çš„æœ€é¢‘ç¹çš„ä¸€ä¸ª hook äº†ã€‚æ¥ä¸‹æ¥çœ‹çœ‹å®˜ç½‘æ€ä¹ˆè§£é‡Šä»–çš„ç”¨æ³•ã€‚ä»–æ˜¯ä¸€ä¸ªåœ¨å‡½æ•°å¼ç»„ä»¶å†…æ·»åŠ æš‚å­˜çŠ¶æ€çš„å‡½æ•°ï¼Œåœ¨ç»„ä»¶æ›´æ–°æ¸²æŸ“æ—¶ï¼Œèƒ½å¤Ÿä¿ç•™stateé‡Œå˜é‡çš„çŠ¶æ€ä¸è¢«åˆå§‹åŒ–ã€‚

åŒå…¶ä»– hook ä¸€æ ·ï¼Œä¸èƒ½åœ¨å¾ªç¯å’Œåˆ¤æ–­æ¡ä»¶é‡Œä½¿ç”¨ï¼Œå®˜æ–¹æ¨èåœ¨ç»„ä»¶é¡¶éƒ¨ä½¿ç”¨ï¼š

```js
import { useState } from 'react';  

function MyComponent() {  
    const [age, setAge] = useState(28);  
    const [name, setName] = useState('Taylor');  
    const [todos, setTodos] = useState(() => createTodos());  
    // ...
}
```

### æ¥å—å‚æ•°ï¼šinitialState

æ¥å—ä¸€ä¸ªåˆå§‹åŒ–çš„å€¼ã€‚åœ¨stateåˆ›å»ºæ—¶ï¼Œä¼šå°†å€¼è®°å½•ä¸ºè¿™ä¸ªåˆå§‹åŒ–çš„å€¼ï¼Œä¸ä¼ é»˜è®¤æ˜¯ `undefined`ã€‚

> P.S. å¦‚æœåˆå§‹åŒ–å€¼ä¼ ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå°†è¢«ä½œä¸ºåˆå§‹åŒ–å‡½æ•°ã€‚è¦æ±‚å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œä¸å¸¦ä»»ä½•å‚æ•°ï¼Œå¹¶ä¸”åº”è¯¥æœ‰è¿”å›å€¼ã€‚åˆå§‹åŒ–å‡½æ•°çš„è¿”å›å°†è¢«è®°å½•ä¸ºåˆå§‹çŠ¶æ€ã€‚è¯¥åˆå§‹åŒ–å‡½æ•°åªä¼šåŠ è½½ä¸€æ¬¡ï¼Œåœ¨ä¸‹ä¸€ä¸ªç»„ä»¶æ¸²æŸ“æ—¶ï¼Œä¸ä¼šè¢«é‡æ–°æ‰§è¡Œ

### è¿”å›å€¼

ä»–çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„è§£æ„çš„å˜é‡ã€‚

- çŠ¶æ€

ç¬¬ä¸€ä¸ªå˜é‡æ˜¯çŠ¶æ€å˜é‡æœ¬èº«

- è®¾ç½®çŠ¶æ€å‡½æ•°

ç¬¬äºŒä¸ªå˜é‡æ˜¯è®¾ç½®çŠ¶æ€çš„å‡½æ•°ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ä¼šé‡æ–°è®¾ç½®stateå€¼å¹¶è§¦å‘ç»„ä»¶çš„ re-render.

è®¾ç½®çŠ¶æ€çš„å‡½æ•°ä½¿ç”¨èŒƒä¾‹ï¼š

```js
const [name, setName] = useState('Edward');  

function handleClick() {  
    setName('Taylor');  
    setAge(a => a + 1);  
    // ...
}
```

### å…³äºè®¾ç½®å‡½æ•°ï¼ˆæ¯”å¦‚ setNameï¼‰

- å…¥å‚

å‚æ•°æ˜¯è¦è®¾ç½®çš„æ–°çŠ¶æ€çš„å€¼ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚

> P.S. å¦‚æœä½ ä¼ äº†ä¸€ä¸ªå‡½æ•°è¿›å»ï¼ˆæ¯”å¦‚ä¸Šé¢çš„ setNameï¼‰ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«ä½œä¸ºæ›´æ–°å‡½æ•°å¯¹å¾…ã€‚åŒæ ·å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯æ›´æ–°ä¹‹å‰çš„çŠ¶æ€å€¼ï¼Œå‡½æ•°çš„è¿”å›å€¼ä¼šè¢«ä½œä¸ºæ–°çš„çŠ¶æ€å€¼ã€‚React ä¼šæŠŠä½ çš„æ›´æ–°å‡½æ•°æ”¾åˆ°ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—é‡Œï¼ˆfiberè°ƒåº¦å™¨ï¼‰ï¼Œåœ¨ä¸‹ä¸€ä¸ªæ¸²æŸ“å‘¨æœŸåˆ°æ¥æ—¶ï¼Œfiberä¼šéå†é˜Ÿåˆ—ï¼ŒæŒ‰ç…§ä¸€å®šçš„ä¼˜å…ˆçº§æ‰§è¡Œå‡½æ•°å¹¶æ¸…ç©ºå¯¹åˆ—ã€‚

- è¿”å›å€¼

### æ–°çš„çŠ¶æ€å€¼

- â­ï¸ è®¾ç½®çŠ¶æ€å‡½æ•°çš„æ³¨æ„äº‹é¡¹

1. çŠ¶æ€åªåœ¨ä¸‹æ¬¡æ›´æ–°æ—¶å¼‚æ­¥å˜åŒ–ï¼Œå¦‚æœåœ¨è®¾ç½®çŠ¶æ€åç«‹å³è¯»å–çŠ¶æ€å€¼ï¼Œè¯»å–åˆ°çš„è¿˜æ˜¯è€çš„çŠ¶æ€ã€‚
2. å¦‚æœæä¾›çš„æ–°å€¼ä¸å½“å‰çŠ¶æ€ç›¸åŒï¼ˆç”± Object.is æ¯”è¾ƒç¡®å®šï¼‰ï¼Œ`React` å°†è·³è¿‡é‡æ–°æ¸²æŸ“ç»„ä»¶åŠå…¶å­ç»„ä»¶ã€‚
3. `React` æ˜¯æ‰¹é‡åˆå¹¶æ›´æ–° state çš„ã€‚å¤šä¸ªçŠ¶æ€æ›´æ–°æ“ä½œä¼šè¢«æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶ååœ¨é€‚å½“çš„æ—¶æœºè¿›è¡Œåˆå¹¶å’Œæ‰¹é‡å¤„ç†ã€‚è¿™å¯ä»¥é˜²æ­¢åœ¨å•ä¸ªäº‹ä»¶æœŸé—´å¤šæ¬¡é‡æ–°æ¸²æŸ“ã€‚åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼Œéœ€è¦å¼ºåˆ¶ `React` æå‰æ›´æ–°ç•Œé¢ï¼Œä¾‹å¦‚è®¿é—® DOMï¼Œå¯ä»¥ä½¿ç”¨ flushSyncã€‚
4. åœ¨æ¸²æŸ“æœŸé—´è°ƒç”¨ set å‡½æ•°åªå…è®¸åœ¨å½“å‰æ¸²æŸ“ç»„ä»¶ä¸­ã€‚ `React` å°†ä¸¢å¼ƒå…¶è¾“å‡ºå¹¶ç«‹å³ä½¿ç”¨æ–°çŠ¶æ€å†æ¬¡æ¸²æŸ“ã€‚ï¼ˆä¸‹è¾¹æœ‰åœ¨æ¸²æŸ“æ—¶è®¾ç½®çŠ¶æ€å€¼çš„ä¾‹å­ï¼‰
5. åœ¨ä¸¥æ ¼æ¨¡å¼ + å¼€å‘ç¯å¢ƒä¸‹ï¼Œåˆå§‹åŒ–å‡½æ•°ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡æ¥å¸®åŠ©ä½ è°ƒè¯•é”™è¯¯ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯çº¯å‡½æ•°ï¼Œç¬¬äºŒæ¬¡ç»“æœä¼šè¢«å¿½ç•¥æ‰ã€‚

### æ³¨æ„äº‹é¡¹

1. ä½œä¸ºä¸€ä¸ªhookï¼Œä»–åœ¨å‡½æ•°å¼ç»„ä»¶å†…æ˜¯å•å‘é“¾è¡¨å­˜å‚¨çš„ï¼Œæ‰€ä»¥å¿…é¡»æ”¾åœ¨ç»„ä»¶é¡¶å±‚ä½¿ç”¨ã€‚å¦‚æœä½ éœ€è¦åœ¨å¾ªç¯æˆ–è€…æ¡ä»¶è¯­å¥é‡Œä½¿ç”¨ï¼Œå°±æå–æˆå•ç‹¬çš„ç»„ä»¶ä½¿ç”¨ã€‚
2. åœ¨ä¸¥æ ¼æ¨¡å¼ + å¼€å‘ç¯å¢ƒä¸‹ï¼Œåˆå§‹åŒ–å‡½æ•°ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡æ¥å¸®åŠ©ä½ è°ƒè¯•é”™è¯¯ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯çº¯å‡½æ•°ï¼Œç¬¬äºŒæ¬¡ç»“æœä¼šè¢«å¿½ç•¥æ‰ã€‚

### å„ç§ä½¿ç”¨ä¾‹å­

#### 1. åœ¨è®¾ç½®çŠ¶æ€åç«‹å³è¯»å–çŠ¶æ€å€¼

```js
function handleClick() {
    const [name, setName] = useState('Taylor');
    //...
    setName('Robin');  
    console.log(name); // Still "Taylor"!  
}
```

å¦‚æœæƒ³è¦è·å–åˆ°å˜åŒ–åçš„å€¼ï¼Œå¯ä»¥ä½¿ç”¨ `useEffect`

#### 2. åŸºç¡€ä½¿ç”¨ï¼šå¤šçŠ¶æ€ä¸è¡¨å•ç»“åˆ

```jsx
import { useState } from 'react';

export default function Form() {
  const [name, setName] = useState('Taylor');
  const [age, setAge] = useState(42);

  return (
    <>
      <input
        value={name}
        onChange={e => setName(e.target.value)}
      />
      <button onClick={() => setAge(age + 1)}>
        Increment age
      </button>
      <p>Hello, {name}. You are {age}.</p>
    </>
  );
}
```

#### 3. åœ¨å®šæ—¶å™¨ä¸­ä½¿ç”¨

åœ¨å®šæ—¶å™¨å›è°ƒå‡½æ•°ä¸­ä½¿ç”¨ç»„ä»¶ï¼š

```js
const [count, setCount] = useState(0);

const counterIntervalFunction = () => {
  console.log(count);
  setCount(count + 1)
};

// ...
const interval = setInterval(counterIntervalFunction, 1000);
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå®šæ—¶å™¨ä¸­è¯•å›¾ä¿®æ”¹stateçš„å€¼ï¼Œä½†æ˜¯ï¼Œå› ä¸ºé—­åŒ…çš„åŸå› ï¼ŒcounterIntervalFunctionä¸­æ‰“å°çš„ç»“æœæ¯æ¬¡éƒ½æ˜¯ 1ï¼Œå¹¶æ²¡æœ‰å®ç°ç´¯åŠ çš„æ•ˆæœã€‚

æ­¤æ—¶å¯ä»¥ä½¿ç”¨ç¬¬äºŒç§å†™æ³•ï¼š

```js
setCount(prev => prev + 1)
```

ä¹Ÿå¯ä»¥å€ŸåŠ© useRefï¼š

```js
const ref = useRef({ count });
useEffect(() => { 
    ref.current = { count }
}, [count]);
```
è¿™æ ·ï¼Œåœ¨ counterIntervalFunction é‡Œæ‹¿ ref.current.count å°±å¯ä»¥å•¦ã€‚å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠæ•´ä¸ªå®šæ—¶å™¨éƒ½æ”¾åœ¨åŸºäºcountçš„ `useEffect` ä¸­ï¼Œä¸€æ ·å¯ä»¥å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚

#### 4. åŸºäºä¸Šä¸€æ¬¡çŠ¶æ€æ›´æ–°çŠ¶æ€å€¼

```js
function handleClick() {  
    // é”™è¯¯å†™æ³•
    setAge(age + 1); // setAge(42 + 1)  
    setAge(age + 1); // setAge(42 + 1)  
    setAge(age + 1); // setAge(42 + 1)  
    
    // æ­£ç¡®å†™æ³• âœ…
    setAge(a => a + 1); // setAge(42 => 43)  
    setAge(a => a + 1); // setAge(43 => 44)  
    setAge(a => a + 1); // setAge(44 => 45)
}
```

#### 5. stateæ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¿®æ”¹stateéœ€è¦æ”¹å˜å¼•ç”¨

```js
// ä¸ç”Ÿæ•ˆ
form.firstName = 'Taylor';

// æ¨è
setForm({  
    ...form,  
    firstName: 'Taylor'  
});
```

#### 6. é¿å…åˆå§‹åŒ–å‡½æ•°é‡å¤æ‰§è¡Œ

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function TodoList() {  
    const [todos, setTodos] = useState(createInitialTodos());  
    // ...
}
```

è™½ç„¶createInitialTodosæœ‰æ•ˆæ‰§è¡Œåªæœ‰ç»„ä»¶æŒ‚è½½æ—¶ä¸€æ¬¡ï¼Œä½†åœ¨ä¹‹åç»„ä»¶å†æ¬¡re-renderæ—¶éƒ½ä¼šè¢«æ‰§è¡Œï¼Œè¿™å°±é€ æˆäº†èµ„æºæµªè´¹ã€‚å…¶å®ä½ åªéœ€è¦ä¼ é€’åˆå§‹åŒ–å‡½æ•°å£°æ˜å°±è¡Œäº†ï¼š

```js
function TodoList() {  
    const [todos, setTodos] = useState(createInitialTodos);  
    // ...
}
```

#### 7. é‡ç½®çŠ¶æ€å€¼

å¯ä»¥å€ŸåŠ© `React` æœ€å¸¸è§çš„ key å€¼æ¥é‡ç½®çŠ¶æ€ï¼š

```js
import { useState } from 'react';

export default function App() {
  const [version, setVersion] = useState(0);

  function handleReset() {
    setVersion(version + 1);
  }

  return (
    <>
      <button onClick={handleReset}>Reset</button>
      <Form key={version} />
    </>
  );
}

function Form() {
  const [name, setName] = useState('Taylor');

  return (
    <>
      <input
        value={name}
        onChange={e => setName(e.target.value)}
      />
      <p>Hello, {name}.</p>
    </>
  );
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒæŠŠä¸€ä¸ª state å½“åškeyä¼ é€’ç»™è¡¨å•ç»„ä»¶ï¼Œå½“éœ€è¦é‡ç½®è¡¨å•ç»„ä»¶æ—¶ï¼Œæ”¹å˜è¿™ä¸ªkeyå€¼ï¼ŒReactç»„ä»¶å°±ä¼šè‡ªè‡ªåŠ¨ re-create ä¸€æ¬¡è¡¨å•ï¼Œè¾¾åˆ°äº†é‡ç½®çš„ç›®çš„ï¼Œé‡ç½®åï¼Œè¡¨å•ç»„ä»¶é‡Œçš„æ‰€æœ‰stateéƒ½ä¼šé‡ç½®ã€‚

#### 8. ç»„ä»¶æ¸²æŸ“æœŸé—´ æ”¹å˜ state

ä¸€èˆ¬ä¸Šï¼ŒçŠ¶æ€å€¼çš„ä¿®æ”¹éƒ½ä¼šæ”¾åœ¨ä¸€ä¸ªäº‹ä»¶çš„handleBaré‡Œï¼Œä½†æ˜¯ï¼Œæœ‰æ—¶å€™ä½ æƒ³è¦åœ¨é™¤äº†äº‹ä»¶ä»¥å¤–çš„å“åº”ä¸­æ”¹å˜çŠ¶æ€å€¼ ï¼ˆæ¯”å¦‚ props æ”¹å˜çš„æ—¶å€™ï¼‰ï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿä¸‹é¢ç»™å‡ºä¸€ä¸ªèŒƒä¾‹ï¼š

```js
import { useState } from 'react';

export default function CountLabel({ count }) {
  const [prevCount, setPrevCount] = useState(count);
  const [trend, setTrend] = useState(null);
  if (prevCount !== count) {
    setPrevCount(count);
    setTrend(count > prevCount ? 'increasing' : 'decreasing');
  }
  return (
    <>
      <h1>{count}</h1>
      {trend && <p>The count is {trend}</p>}
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨èµ·æ¥éœ€æ³¨æ„ï¼Œ`prevCount !== count`çš„åˆ¤æ–­æ¡ä»¶ä¸èƒ½çœå»ï¼Œä¸ç„¶å°±ä¼šé™·å…¥åå¤ set çŠ¶æ€çš„æ­»å¾ªç¯é‡Œã€‚

å½“ç„¶äº†ï¼Œä½ ä¹Ÿå¯ä»¥åƒä¸Šä¸€ç¯‡æ–‡ç« é‚£æ ·ï¼Œä½¿ç”¨ useMemo è·å¾—è®¡ç®—å±æ€§ã€‚

### Q&A

#### 1. æˆ‘å·²ç»æ›´æ–°äº†çŠ¶æ€ï¼Œä½†æ˜¯console.logæ‰“å°äº†æ—§çš„å€¼

```js
function handleClick() {  
    console.log(count); // 0  
    setCount(count + 1); // Request a re-render with 1  
    console.log(count); // Still 0!  
    
    setTimeout(() => {  
        console.log(count); // Also 0!  
    }, 5000);  
}
```

å› ä¸ºReact çš„stateç±»ä¼¼äºå¿«ç…§ï¼Œæ›´æ–°äº†çŠ¶æ€åï¼Œå¹¶ä¸å½±å“ä¹‹å‰å·²ç»åœ¨fiberä»»åŠ¡äº‹ä»¶å¾ªç¯é‡Œçš„çŠ¶æ€ã€‚å¦‚æœéœ€è¦ç«‹å³ä½¿ç”¨ï¼Œå¯ä»¥å€ŸåŠ©ä¸´æ—¶å˜é‡ï¼š

```js
const nextCount = count + 1;  

setCount(nextCount);  

console.log(count); // 0  

console.log(nextCount); // 1
```

#### 2. æˆ‘å·²ç»æ›´æ–°äº†çŠ¶æ€ï¼Œä½†æ˜¯ç•Œé¢ä¸å˜åŒ–

å‰åä¸¤æ¬¡ä¿®æ”¹çš„çŠ¶æ€ï¼Œå¦‚æœç›¸ç­‰ï¼ˆObject.isï¼‰çš„è¯ï¼Œå°±ä¸ä¼šå»è§¦å‘æ¸²æŸ“ã€‚é”™è¯¯ç¤ºèŒƒï¼š

```js
obj.x = 10; // ğŸš© Wrong: mutating existing object  
setObj(obj); // ğŸš© Doesn't do anything
```

æ­£ç¡®ä½¿ç”¨æ–¹å¼ï¼š

```js
// âœ… Correct: creating a new object
setObj({
  ...obj,
  x: 10
});
```

#### 3. æ§åˆ¶å°æŠ¥é”™ â€œToo many re-renders. React limits the number of renders to prevent an infinite loop.â€

ä¸€èˆ¬è¿™ç§æƒ…å†µå°±æ˜¯ç»„ä»¶æ¸²æŸ“è¿›å…¥äº†æ­»å¾ªç¯ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¯èƒ½çš„ä¾‹å­åŠè§£å†³æ–¹æ¡ˆï¼š

```js
// ğŸš© Wrong: calls the handler during render
return <button onClick={handleClick()}>Click me</button>

// âœ… Correct: passes down the event handler
return <button onClick={handleClick}>Click me</button>

// âœ… Correct: passes down an inline function
return <button onClick={(e) => handleClick(e)}>Click me</button>
```

#### 4. æˆ‘æƒ³è¦æŠŠä¸€ä¸ªå‡½æ•°ä½œä¸º stateï¼Œä½†æ˜¯å´å½“æˆäº†åˆå§‹å‡½æ•°æ‰§è¡Œäº†

ä¸Šé¢çš„è®²è¿‡ï¼ŒuseState çš„å…¥å‚å¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™ä¼šå°†å‡½æ•°æ‰§è¡Œç»“æœä½œä¸ºåˆå§‹å‡½æ•°ã€‚å¦‚æœä¸€å®šè¦ä¼ ä¸€ä¸ªå‡½æ•°ä½œä¸ºçŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨é«˜é˜¶å‡½æ•°ï¼š

```js
const [fn, setFn] = useState(() => someFunction);

function handleClick() {
  setFn(() => someOtherFunction);
}
```

## 2. useReducer

useReducer æ˜¯ä¸€ä¸ªä¸€èˆ¬åŒ–çš„ useStateï¼Œæ¯” useState å¤šäº†ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ ¹æ®ä¸åŒçš„åˆ†å‘çŠ¶æ€æ¥ç›¸åº”çš„æ”¹å˜çŠ¶æ€ã€‚å¯ä»¥è¿™ä¹ˆç†è§£ï¼ŒuseReducer æ˜¯ä¸€ä¸ªæå‰å†™å¥½äº†æ€ä¹ˆå¤„ç† state çš„å‡½æ•°çš„ useStateã€‚

å£°æ˜æ ¼å¼ï¼š

```js
const [state, dispatch] = useReducer(reducer, initialArg, init)
```

### æ¥æ”¶å‚æ•°

1. reducer

reducer å‡½æ•°æŒ‡å®šå¦‚ä½•æ›´æ–°çŠ¶æ€ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ã€‚

2. initialArg

çŠ¶æ€çš„åˆå§‹å€¼

3. init

å¯é€‰åˆå§‹åŒ–å¤„ç†å‡½æ•°ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™åˆå§‹çŠ¶æ€è®¾ç½®ä¸º initialArgã€‚å¦åˆ™ï¼Œåˆå§‹çŠ¶æ€è®¾ç½®ä¸ºè°ƒç”¨ `init(initialArg)` çš„ç»“æœã€‚

### è¿”å›å€¼

1. state ä¸ºå½“å‰çš„çŠ¶æ€å€¼
2. dispatch å‡½æ•°ï¼Œç”¨äºæ›´æ–°çŠ¶æ€

### æ³¨æ„äº‹é¡¹

ä½¿ç”¨æ–¹å¼åŒ useState

### åŸºæœ¬ä½¿ç”¨

```js
import { useReducer } from 'react';

function reducer(state, action) {
  // ...
}

const [state, dispatch] = useReducer(reducer, { age: 42 });

function handleClick() {
  dispatch({ type: 'incremented_age' });
  // ...
}
```

#### dispatch å‡½æ•°

æ¥å—ä¸€ä¸ª state å’Œ actionã€‚action å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„å€¼ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ ‡å¿—ä½ + payload çš„å½¢å¼ï¼›åŒæ—¶ï¼Œdispatch å‡½æ•°æ²¡æœ‰è¿”å›å€¼ã€‚

### ä½¿ç”¨ä¾‹å­

###### 1. ä¸formè¡¨å•ç»“åˆ

```jsx
import { useReducer } from 'react';

function reducer(state, action) {
  switch (action.type) {
    case 'incremented_age': {
      return {
        ...state,
        age: state.age + 1
      };
    }
    case 'changed_name': {
      return {
        name: action.nextName,
        age: state.age
      };
    }
  }
  
  // è¿™é‡Œå¤„ç†æœªçŸ¥æƒ…å†µï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æŠ›å‡ºé”™è¯¯
  throw Error('Unknown action: ' + action.type);
}

const initialState = { name: 'Taylor', age: 42 };

export default function Form() {
  const [state, dispatch] = useReducer(reducer, initialState);

  function handleButtonClick() {
    dispatch({ type: 'incremented_age' });
  }

  function handleInputChange(e) {
    dispatch({
      type: 'changed_name',
      nextName: e.target.value
    }); 
  }

  return (
    <>
      <input
        value={state.name}
        onChange={handleInputChange}
      />
      <button onClick={handleButtonClick}>
        Increment age
      </button>
      <p>Hello, {state.name}. You are {state.age}.</p>
    </>
  );
}
```

è¡¨å•å…ƒç´ çš„ value æ˜¯ stateå†…éƒ¨çš„å€¼ï¼Œåœ¨è¡¨å•å…ƒç´ æ”¹å˜çš„äº‹ä»¶ä¸­ï¼Œdispatchè¿™ä¸ªreducerï¼Œdispatché‡Œä¼ äº†ä¸ª typeå’Œä¸€ä¸ª payload é¡¹ï¼šnextNameï¼Œæ­¤æ—¶ï¼Œreducerå°±å¯ä»¥æ¥æ”¶å‚æ•°äº†ï¼šstateå°±æ˜¯å½“å‰å˜æ›´å‰çš„çŠ¶æ€å€¼ï¼Œactionå°±æ˜¯ dispatch ä¼ é€’çš„å‚æ•°ã€‚

> P.S. reducer å‡½æ•°é‡Œä¸èƒ½ç›´æ¥æ”¹ stateï¼š`state.age = state.age + 1;`ï¼Œä»–åº”è¯¥è¿”å›ä¸€ä¸ªæ–°çš„å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè‡ªåŠ¨è¢« useReducer è®¾ç½®ã€‚

###### 2. é¿å…é‡æ–°æ‰§è¡Œåˆå§‹å‡½æ•°

è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function createInitialState(username) {  
    // ...  
}  

function TodoList({ username }) {  
    const [state, dispatch] = useReducer(reducer, createInitialState(username));  
    // ...
}
```

ç¬¬äºŒä¸ªå‚æ•°æœ¬æ¥æ˜¯åˆå§‹åŒ–çŠ¶æ€çš„ä½ç½®ï¼Œä¼ äº†ä¸ªå‡½æ•°è°ƒç”¨ï¼Œè€Œä¸æ˜¯å‡½æ•°å£°æ˜ï¼Œåœ¨æ¯æ¬¡ç»„ä»¶re-renderæ—¶éƒ½ä¼šè¢«æ‰§è¡Œï¼Œå½±å“æ€§èƒ½ã€‚

è€ƒè™‘å¦‚ä¸‹æ”¹é€ ï¼š

```js
const [state, dispatch] = useReducer(reducer, username, createInitialState);
```
ç¬¬äºŒä¸ªå‚æ•°è¿˜æ˜¯é™æ€çš„åˆå§‹å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è‡ªå®šä¹‰çš„åˆå§‹åŒ–å¤„ç†å‡½æ•°ï¼Œåœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šå°† `createInitialState(username)` çš„è¿”å›å€¼ä½œä¸ºåˆå§‹å€¼ã€‚

### Q&A

###### 1. dispatch åå¦‚ä½•ä½¿ç”¨æœ€æ–°çš„çŠ¶æ€å€¼

ä¸ useState ç±»ä¼¼ï¼Œéœ€ä½¿ç”¨å±€éƒ¨å˜é‡ï¼š

```js
const action = { type: 'incremented_age' };
dispatch(action);

const nextState = reducer(state, action);
console.log(state);     // { age: 42 }
console.log(nextState); // { age: 43 }
```

###### 2. æˆ‘çš„ reducer ä¸ºä»€ä¹ˆæ€»æ˜¯è¢«æ‰§è¡Œäº†å¤šæ¬¡ï¼Ÿ

è¿™ä¸ªè¿˜æ˜¯è·Ÿä¸¥æ ¼æ¨¡å¼å’Œå¼€å‘ç¯å¢ƒæœ‰å…³ç³»çš„ã€‚å¼€å‘ç¯å¢ƒä¼šå¸®ä½ æ£€æµ‹ä½ çš„ reducer æ˜¯å¦æ˜¯çº¯å‡½æ•°ã€‚è€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function reducer(state, action) {
  switch (action.type) {
    case 'added_todo': {
      // ğŸš© Mistake: mutating state
      state.todos.push({ id: nextId++, text: action.text });
      return state;
    }
    // ...
  }
}
```
ä¸Šé¢çš„ reducer å°±ä¸æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œä¸¤æ¬¡ï¼Œtodosæ•°ç»„æ•°æ®å°±ä¼šé”™ä¹±ï¼Œå¼€å‘è€…å°±å¾ˆå®¹æ˜“å‘ç°é—®é¢˜å¹¶åŠæ—¶æ”¹æ­£ã€‚ä¸‹é¢ç»™å‡ºæ­£ç¡®çš„å‚è€ƒï¼š

```js
// âœ… Correct: replacing with new state
return {
  ...state,
  todos: [
    ...state.todos,
    { id: nextId++, text: action.text }
  ]
};
```

> ä¸çŸ¥ä¸è§‰ï¼Œå†™åˆ°è¿™é‡Œå·²ç» 1W å­—äº†...

----

æœ¬æœŸçš„å®˜ç½‘è§£è¯»å°±åˆ°è¿™é‡Œå•¦ï¼Œå€ºè§ï¼
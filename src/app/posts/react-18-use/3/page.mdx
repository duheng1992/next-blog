# æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆä¸‰ï¼‰- Hooks ä¹‹ useEffectã€useLayoutEffect å’Œ useInsertionEffect
---

- å®˜ç½‘åœ°å€ï¼š[React](https://beta.reactjs.org/)

## 1. ä½¿ç”¨åœºæ™¯å¯¹æ¯”

- `useEffect`: ç”¨äºå‰¯ä½œç”¨æ•è·ï¼Œåœ¨ dom å…ƒç´ æ¸²æŸ“ä¹‹åè°ƒç”¨ï¼Œå¸¸ç”¨äºé¡µé¢æ•°æ®å¤„ç†å·¥ä½œã€‚
- `useLayoutEffect`: useEffect çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œåœ¨ DOM æ›´æ–°ä¹‹ååŒæ­¥æ‰§è¡Œï¼Œä½†åœ¨æµè§ˆå™¨ç»˜åˆ¶ä¹‹å‰æ‰§è¡Œï¼Œå¸¸ç”¨äºé¡µé¢å…ƒç´ å¸ƒå±€å·¥ä½œï¼Œå¯èƒ½ä¼šé˜»å¡é¡µé¢æ¸²æŸ“ã€‚
- `useInsertionEffect`: useEffect çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œåœ¨ DOM æ›´æ–°å‰æ‰§è¡Œã€‚å¸¸ç”¨äº CSS-in-JS æ’å…¥åŠ¨æ€æ ·å¼ã€‚


## 2. useEffect

useEffect æ˜¯ä¸€ä¸ªæ•è·å‰¯ä½œç”¨çš„å‡½æ•°ï¼Œç”¨æ¥ä»£æ›¿ç±»å¼ç»„ä»¶ä¸­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚å£°æ˜æ–¹å¼å¦‚ä¸‹ï¼š

```js
useEffect(setup, dependencies)
```

### å‚è€ƒèŒƒä¾‹

æ³¨æ„éœ€åœ¨ç»„ä»¶é¡¶å±‚ä½¿ç”¨

```js
function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      connection.disconnect();
    };
  }, [serverUrl, roomId]);
  // ...
}
```

### æ¥æ”¶å‚æ•°

1. setupï¼šå…·æœ‰ Effect é€»è¾‘çš„è®¾ç½®å‡½æ•°ã€‚å½“ä½ çš„ç»„ä»¶è¢«æ·»åŠ åˆ° DOM æ—¶ï¼ŒReact å°†è¿è¡Œä½ çš„è®¾ç½®å‡½æ•°ã€‚åœ¨æ¯æ¬¡ä½¿ç”¨æ›´æ”¹çš„ä¾èµ–é¡¹é‡æ–°æ¸²æŸ“åï¼ŒReact å°†é¦–å…ˆä½¿ç”¨æ—§å€¼è¿è¡Œæ¸…ç†å‡½æ•°ï¼ˆå¦‚æœä½ æä¾›äº†å®ƒï¼‰ï¼Œç„¶åä½¿ç”¨æ–°å€¼è¿è¡Œä½ çš„è®¾ç½®å‡½æ•°ã€‚åœ¨ä½ çš„ç»„ä»¶ä» DOM ä¸­ç§»é™¤åï¼ŒReact å°†è¿è¡Œä½ çš„æ¸…ç†å‡½æ•°ã€‚

å…¶ä¸­æ¸…ç†å‡½æ•°èŒƒä¾‹å¦‚ä¸‹ï¼š

```js
useEffect(
    // è®¾ç½®å‡½æ•°
    () => {
        const connection = createConnection(serverUrl, roomId);
        connection.connect();

        // æ¸…ç†å‡½æ•°
        return () => {
            connection.disconnect();
        };
    },
    // ä¾èµ–
    [serverUrl, roomId]
);
```
2. ä¾èµ–é¡¹ï¼ˆå¯é€‰ï¼‰ï¼šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€šè¿‡ `Object.is` æ¥ä¾æ¬¡åˆ¤æ–­å„ä¸ªä¾èµ–é¡¹æ˜¯å¦å˜åŒ–ï¼Œè‹¥æœ‰è‡³å°‘ä¸€ä¸ªå‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ‰§è¡Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°ã€‚å¦‚æœæœ‰å¤šä¸ªä¾èµ–é¡¹æ›´æ–°ï¼Œåœ¨ä¸€ä¸ªfiberæ›´æ–°å‘¨æœŸå†…ï¼Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°ä¹Ÿ**åªä¼šæ‰§è¡Œä¸€æ¬¡**ã€‚è‹¥çœç•¥æ­¤å‚æ•°ï¼Œè®¾ç½®å‡½æ•°å’Œæ¸…ç†å‡½æ•°å°†åœ¨æ¯æ¬¡ç»„ä»¶æ¸²æŸ“æ—¶æ‰§è¡Œã€‚

### è¿”å›å‚æ•°

undefined

### æ³¨æ„äº‹é¡¹

1. ä»–æ˜¯ä¸€ä¸ªhookï¼Œåªèƒ½åœ¨å‡½æ•°å¼ç»„ä»¶æœ€å¤–å±‚ä½¿ç”¨ï¼Œä¸”ä¸èƒ½æ”¾åœ¨å¾ªç¯å’Œæ¡ä»¶è¯­å¥ä¸­ã€‚
2. ä»–çš„ä½œç”¨æ˜¯æ£€æµ‹ä¾èµ–é¡¹å˜åŒ–åæ‰§è¡Œï¼Œè‹¥ä¸ºç©ºæ•°ç»„ä¾èµ–ï¼Œåˆ™é»˜è®¤åœ¨ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚
3. ä¸¥æ ¼æ¨¡å¼ä¸‹ `useEffect` æœ‰ä¸€ç§ç‰¹æ®Šè¡Œä¸ºï¼Œå³åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¹‹å‰ä¼šè¿è¡Œä¸€ä¸ªé¢å¤–çš„è®¾ç½®å’Œæ¸…ç†å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯çš„ç›®çš„æ˜¯ä¸ºäº†éªŒè¯è®¾ç½®é€»è¾‘å’Œæ¸…ç†é€»è¾‘æ˜¯å¦ç›¸äº’åŒ¹é…ï¼Œä»¥åŠæ¸…ç†é€»è¾‘æ˜¯å¦èƒ½å¤Ÿæ­£ç¡®åœ°åœæ­¢æˆ–æ’¤é”€è®¾ç½®é€»è¾‘æ‰€åšçš„æ“ä½œã€‚å¦‚æœä½ åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹é‡åˆ°äº†ä¸ `setup å’Œ cleanup` ç›¸å…³çš„é—®é¢˜ï¼Œå®˜æ–¹å»ºè®®ä½ å®ç°é€‚å½“çš„æ¸…ç†å‡½æ•°æ¥è§£å†³ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ç»„ä»¶å¸è½½æˆ–é‡æ–°æ¸²æŸ“æ—¶è¿›è¡Œå¿…è¦çš„æ¸…ç†æ“ä½œï¼Œé¿å…æ½œåœ¨çš„é—®é¢˜å’Œé”™è¯¯ã€‚
4. å¦‚æœä¾èµ–é¡¹ä¸­çš„éƒ¨åˆ†å˜é‡æˆ–è€…å‡½æ•°å®šä¹‰åœ¨äº†ç»„ä»¶å†…éƒ¨ï¼Œå°±ä¼šæœ‰é£é™©ï¼šç»„ä»¶æ¯æ¬¡æ¸²æŸ“å¯¼è‡´è¿™ä¸ªå‡½æ•°æˆ–è€…å˜é‡é‡æ–°åŠ è½½ï¼Œè¿›è€Œå¯¼è‡´ `useEffect` æ¯æ¬¡éƒ½æ‰§è¡Œã€‚è€ƒè™‘æå–ä¿®æ”¹é€»è¾‘ä»£ç æˆ–è€…ä½¿ç”¨ `useCallback` æŠ€æœ¯ã€‚
5. `useEffect` æ˜¯åœ¨ dom æµç»˜åˆ¶å®Œæˆåæ‰§è¡Œçš„ï¼Œå¦‚æœä½ æƒ³è¦é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹ä¸­åœ¨è¯¥å‡½æ•°ä¸­å¤„ç† dom ç»“æ„ï¼Œå¯ä»¥è€ƒè™‘æ”¾åœ¨ useLayoutEffect ä¸­ã€‚
6. `useEffect` ä»…åœ¨å®¢æˆ·ä¾§èƒ½ä½¿ç”¨ï¼ŒæœåŠ¡ä¾§ä½¿ç”¨è¯¦è§æˆ‘ä¹‹åçš„æ–‡ç« ã€‚

### è¿è¡Œæµç¨‹

æˆ‘ä»¬ä½¿ç”¨ä¸Šé¢çš„èŠå¤©å®¤çš„ä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ `useEffect` è¿è¡Œæµç¨‹ã€‚React ä¼šåœ¨å¿…è¦æ—¶è°ƒç”¨ä¸€æ¬¡æˆ–å¤šæ¬¡ä½ çš„è®¾ç½®å’Œæ¸…ç†å‡½æ•°ã€‚

1. ç»„ä»¶åˆå§‹åŒ–æ—¶ï¼ŒuseEffect çš„è®¾ç½®å‡½æ•°æ‰§è¡Œä¸€æ¬¡
2. ä¾èµ–é¡¹æ›´æ–°æ—¶ï¼š
- ä½¿ç”¨æ—§çš„propså’Œstateï¼Œæ¸…ç†å‡½æ•°æ‰§è¡Œä¸€æ¬¡
- ä½¿ç”¨æ–°çš„propså’Œstateï¼Œè®¾ç½®å‡½æ•°æ‰§è¡Œä¸€æ¬¡
3. ç»„ä»¶é”€æ¯æˆ–è€…é‡æ¸²æŸ“æ—¶ï¼Œæ¸…ç†å‡½æ•°ä¼šæ‰§è¡Œä¸€æ¬¡

> useEffect çš„ä½œç”¨åœ¨äºæä¾›ä¸€ç§å°† `React`éå—æ§çš„ç³»ç»Ÿä¸ `React` çš„çŠ¶æ€é“¾æ¥çš„ä¸€ä¸ªåª’ä»‹ã€‚`React`éå—æ§ç³»ç»Ÿæ¯”å¦‚ setIntervalã€addEventListenerã€animation.start() ç­‰ã€‚å¦‚æœæ²¡æœ‰éå—æ§ç³»ç»Ÿå‚ä¸ï¼ŒuseEffect å¾€å¾€ä¸æ˜¯å¿…é¡»çš„ã€‚

### å„ç§ä½¿ç”¨ä¾‹å­

#### 1. ç›‘å¬é¼ æ ‡äº‹ä»¶

ä¸‹é¢çš„ä¾‹å­ï¼Œç›‘å¬äº†é¼ æ ‡æŒ‡é’ˆæ»‘åŠ¨äº‹ä»¶ï¼Œå¹¶åœ¨é¼ æ ‡æŒ‡é’ˆä¸‹æ–¹è®¾ç½®è·Ÿéšçš„åœ†å½¢é˜´å½±è£…é¥°ï¼š

```js
import { useState, useEffect } from 'react';

export default function App() {
  const [position, setPosition] = useState({ x: 0, y: 0 });

  useEffect(() => {
    function handleMove(e) {
      setPosition({ x: e.clientX, y: e.clientY });
    }
    window.addEventListener('pointermove', handleMove);
    return () => {
      window.removeEventListener('pointermove', handleMove);
    };
  }, []);

  return (
    <div style={{
      position: 'absolute',
      backgroundColor: 'pink',
      borderRadius: '50%',
      opacity: 0.6,
      transform: `translate(${position.x}px, ${position.y}px)`,
      pointerEvents: 'none',
      left: -20,
      top: -20,
      width: 40,
      height: 40,
    }} />
  );
}
```

#### 2. è®¾ç½®ä¸€æ®µåŠ¨ç”»ï¼ˆéƒ¨åˆ†ä»£ç ï¼‰

ç‚¹å‡»æŒ‰é’®ï¼Œåœ¨é¡µé¢æ¸å˜çš„æ˜¾ç¤ºä¸€ä¸ªå—çº§å…ƒç´ ï¼ˆ[å®Œæ•´ä»£ç ](https://codesandbox.io/s/ld0mxv?file=/animation.js:463-472&utm_medium=sandpack)ï¼‰ï¼š

```js
useEffect(() => {
    const animation = new FadeInAnimation(ref.current);
    animation.start(1000);
    return () => {
      animation.stop();
    };
  }, []);
```

#### 3. è¿½è¸ªå…ƒç´ ç»è¿‡å¯è§†åŒºåŸŸï¼ˆéƒ¨åˆ†ä»£ç ï¼‰

ä¸‹é¢çš„ä»£ç ï¼Œåœ¨æ‰“äº† ref çš„ div è¿›å…¥å¯è§†åŒºåŸŸåï¼Œæ·»åŠ èƒŒæ™¯è‰²å’Œå­—ä½“è‰²ï¼Œç¦»å¼€å¯è§†åŒºåŸŸåæ ·å¼å¤åŸï¼š

```js
useEffect(() => {
    const div = ref.current;
    const observer = new IntersectionObserver(entries => {
      const entry = entries[0];
      if (entry.isIntersecting) {
        document.body.style.backgroundColor = 'black';
        document.body.style.color = 'white';
      } else {
        document.body.style.backgroundColor = 'white';
        document.body.style.color = 'black';
      }
    });
    observer.observe(div, {
      threshold: 1.0
    });
    return () => {
      observer.disconnect();
    }
  }, []);
```

#### 4. åœ¨è‡ªå®šä¹‰ Hook ä¸­ä½¿ç”¨

æˆ‘ä»¬è¿˜ä»¥ä¸Šé¢èŠå¤©å®¤çš„ä¾‹å­åšè¯´æ˜ã€‚ä¸Šé¢çš„åŠŸèƒ½æ˜¯ roomId å’Œ service åˆ‡æ¢å°±è‡ªåŠ¨å…³é—­æ—§çš„é“¾æ¥ï¼Œæ‰“å¼€æ–°çš„é“¾æ¥ï¼Œæ‰€æœ‰çš„èŠå¤©é“¾æ¥åŠ¨ä½œéƒ½ä¸€æ ·ï¼Œå¯ä»¥æå–æˆå…¬å…±ç»„ä»¶æ¥ä½¿ç”¨ï¼š

```js
function useChatRoom({ serverUrl, roomId }) {
  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]);
}
```

è¿™æ ·ï¼Œåªéœ€è¦ä½¿ç”¨è¿™ä¸ªå‡½æ•°å°±èƒ½å®ŒæˆèŠå¤©å®¤çš„é“¾æ¥å·¥ä½œï¼š

```js
useChatRoom({  
    roomId: roomId,  
    serverUrl: serverUrl  
});
```

å½“ç„¶äº†ï¼Œ[å…¨å±€éå—æ§äº‹ä»¶ï¼ˆaddEventListenerï¼‰](https://codesandbox.io/s/b006ec?file=/useWindowListener.js&utm_medium=sandpack)ã€[å¯è§†åŒºåŸŸç›‘å¬](https://codesandbox.io/s/m9drvd?file=/useIntersectionObserver.js&utm_medium=sandpack)ä¹Ÿå¯ä»¥å°è£…ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ Hook æ¥ä½¿ç”¨ã€‚

#### 5. ä½¿ç”¨å®šæ—¶å™¨æ“ä½œ state

å¦‚æœæƒ³è¦åœ¨ `useState` é‡Œä½¿ç”¨å®šæ—¶å™¨æ“ä½œçŠ¶æ€å€¼ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·å†™ï¼š

```js
unction Counter() {  
    const [count, setCount] = useState(0);  

    useEffect(() => {  
        const intervalId = setInterval(() => {  
            setCount(count + 1); // You want to increment the counter every second...  
        }, 1000)  

        return () => clearInterval(intervalId);  
    }, [count]); // ğŸš© ... but specifying `count` as a dependency always resets the interval.  
    // ...  
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œcount æ˜¯ä¸€ä¸ªå“åº”å€¼ï¼Œåœ¨ useEffect ä¸­å¼•å…¥äº†ä»–çš„ä¾èµ–ï¼ŒåŒæ—¶ï¼Œè¿™æ˜¯å‡½æ•°ä¸­åˆæ”¹å˜äº†ä»–çš„å€¼ï¼Œè¿™å°±å¯¼è‡´äº† setInterval å‡½æ•°ä¼šè¢«åå¤çš„æ‰§è¡Œï¼Œå®šæ—¶å™¨æ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å‡ºæ¥ã€‚ä»£ç é€»è¾‘å‡ºç°é”™è¯¯ä¸è¯´ï¼Œä¹Ÿæµªè´¹äº†å†…å­˜ç©ºé—´ã€‚

è§£å†³æ–¹æ¡ˆå…¶å®å¾ˆç®€å•ï¼Œä¸Šä¸€ç¯‡æ–‡ç« è®² `useState` çš„æ—¶å€™æåˆ°è¿‡ï¼ŒuseState å†…éƒ¨å¯ä»¥ä¼ ä¸€ä¸ªå‡½æ•°ï¼Œä»–çš„å‚æ•°å°±æ˜¯ä¸Šä¸€æ¬¡æ›´æ–°å®Œä¹‹åçš„çŠ¶æ€å€¼ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶ä¸éœ€è¦å»æ‹¿ count è¿™ä¸ªå˜é‡ï¼š

```js
useEffect(() => {
  const intervalId = setInterval(() => {
    setCount(c => c + 1); // âœ… Pass a state updater
  }, 1000);
  return () => clearInterval(intervalId);
}, []); // âœ… Now count is not a dependency
```

### å…³äºä¾èµ–

ä¸æ¨èä¸å¼•å…¥å¿…é¡»çš„ä¾èµ–æˆ–è€…æ·»åŠ é¢å¤–çš„ä¸éœ€è¦çš„ä¾èµ–é¡¹ã€‚ä½ çš„ä¾èµ–é¡¹çš„é€‰æ‹©å–å†³äº `useEffect` åŒ…è£¹çš„ä»£ç ã€‚

ä¾èµ–çš„é€‰æ‹©ä¸ä»…åŒ…æ‹¬è®¾ç½®å‡½æ•°å†…æ‰€åº”ç”¨çš„å˜é‡ã€å‡½æ•°ï¼Œè¿˜åº”è€ƒè™‘åˆ°å„ä¸ªå˜é‡ã€å‡½æ•°å„è‡ªçš„å¼•ç”¨ä¾èµ–ã€‚å¦‚æœå¼•ç”¨çš„å‡½æ•°å†…çš„å˜é‡å˜åŒ–å¼•èµ·äº†è¯¥å‡½æ•°é‡æ–°è®¾ç½®ï¼Œè¿›è€Œä¾¿ä¼šè§¦å‘ `useEffec` æ‰§è¡Œã€‚

åœ¨ä¸Šé¢çš„èŠå¤©å®¤ä¾‹å­ä¸­ï¼ŒrootId æ˜¯é€šè¿‡ç”¨æˆ·ä¸‹æ‹‰åˆ‡æ¢å¾—æ¥çš„ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼›ä½†æ˜¯ serverUrl æ˜¯ä¸€ä¸ªå¸¸é‡å­—ç¬¦ä¸²ï¼Œå®Œå…¨ä¸éœ€è¦æ”¾åœ¨ state é‡Œï¼Œè¿›è€Œä¹Ÿå¯ä»¥ç§»å‡ºä¾èµ–é¡¹ï¼š

```js
useEffect(() => {  
    const connection = createConnection(serverUrl, roomId);  
    connection.connect();  

    return () => connection.disconnect();  
}, [roomId]); // âœ… All dependencies declared
```

å¦‚æœåŒ…è£¹çš„å‡½æ•°æ²¡æœ‰ä»»ä½•å¯å“åº”çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±ç”¨ä¸€ä¸ªç©ºæ•°ç»„å³å¯ã€‚

### é£é™©é¡¹

å¯ä»¥é€šè¿‡ä¸€å®šçš„æ³¨é‡Šæ¬ºéª—ä¾èµ–é¡¹æ£€æŸ¥ï¼Œæ¯”å¦‚ï¼š

```js
useEffect(() => {
  // ...
  // ğŸ”´ Avoid suppressing the linter like this:
  // eslint-ignore-next-line react-hooks/exhaustive-deps
}, []);
```

è¿™ç§æƒ…å†µåœ¨ä½ è‚¥è‚ æ˜ç¡®åŒ…è£¹å‡½æ•°çš„ä¾èµ–å…³ç³»æ—¶æ‰å¯ä½¿ç”¨ï¼Œä½†æ˜¯è¿™åŒæ ·ä¸åˆ©äºå›¢é˜Ÿåˆä½œä¸­çš„ä»£ç ç»´æŠ¤ã€‚å¦‚æœåŒ…è£¹å‡½æ•°ä¸­çš„å˜é‡æˆ–è€…å‡½æ•°åœ¨ä»£ç è¿­ä»£ç»´æŠ¤è¿‡ç¨‹ä¸­å˜æˆäº†å“åº”å¼çš„ï¼Œä½†æ˜¯è¿™é‡ŒåˆæŠ‘åˆ¶äº†å‘Šè­¦æç¤ºï¼Œå¯èƒ½ä¼šå‡ºç°éš¾ä»¥æ’æŸ¥çš„é—®é¢˜ã€‚

> P.S. å¯èƒ½ä½ ä¼šè§‰å¾—: æˆ‘ä½¿ç”¨ç©ºæ•°ç»„å°±æ˜¯è¡¨ç¤ºç»„ä»¶åˆå§‹åŒ–åŠ è½½æ—¶è°ƒç”¨çš„å•Šï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç»™æˆ‘å¼¹è­¦å‘Šï¼Ÿè¿™é‡Œï¼Œä½œè€…å»ºè®®ï¼Œä¸è¦åœ¨å‡½æ•°å¼ç»„ä»¶é‡Œè°ˆç”Ÿå‘½å‘¨æœŸï¼Œè¿™é‡Œåªæœ‰å“åº”å¼å‰¯ä½œç”¨å’Œå¸¸é‡ã€‚

## 3. å®éªŒæ€§APIï¼šuseEffectEvent

> è¯¥APIè¿˜å¤„äºè¯•éªŒé˜¶æ®µï¼Œæ­£å¼releaseç‰ˆå°šæœªå‘å¸ƒã€‚

ç†è®ºä¸Šï¼Œä¾èµ–æ›´æ–°äº†ï¼Œè®¾ç½®å‡½æ•°å°±ä¼šé‡æ–°æ‰§è¡Œï¼Œè€ƒè™‘ä¸‹é¢è®°å½•é¡µé¢è®¿é—®é‡çš„ä»£ç ï¼š

```js
function Page({ url, shoppingCart }) {  
    useEffect(() => { 
        // ...
        logVisit(url, shoppingCart.length);  
    }, [url, shoppingCart]); // âœ… All dependencies declared  
    // ...  
}
```
urlå’ŒshoppingCartå˜åŒ–ï¼Œéƒ½ä¼šé‡æ–°è°ƒç”¨logVisitå‡½æ•°æ¥å¢åŠ è®¿é—®è®¡æ•°ã€‚ä½†æ˜¯ï¼Œä½ åªå¸Œæœ›è®¿é—®urlå˜åŒ–æ—¶æ‰å¢åŠ è®¿é—®é‡ï¼ŒshoppingCartå˜åŒ–æ—¶logVisitä¸è¦é‡æ–°æ‰§è¡Œï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ—¶ï¼Œè´­ç‰©è½¦åˆå¾—æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿ

ç›´æ¥ç§»é™¤ä¾èµ–å¯èƒ½ä¼šå½±å“å‡½æ•°å†…éƒ¨å…¶ä»–åœ°æ–¹çš„å˜åŒ–ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨ `useEffectEvent`:

```js
function Page({ url, shoppingCart }) {
  const onVisit = useEffectEvent(visitedUrl => {
    // éå“åº”å¼çš„ï¼Œå³å¯ä»¥æ‹¿åˆ°å®æ—¶å…¶ä»–å“åº”å¼æ•°æ®ï¼Œåˆé¿å…äº†ä»–çš„å˜åŒ–å¼•èµ·å¤–éƒ¨æ›´æ–°
    logVisit(visitedUrl, shoppingCart.length)
  });

  useEffect(() => {
    onVisit(url);
  }, [url]); // âœ… All dependencies declared
  // ...
}
```
ä¸Šé¢çš„ä»£ç ï¼Œåœ¨urlå˜åŒ–åï¼Œä¼šæ‰§è¡ŒonVisit -> logVisitå‡½æ•°ï¼Œè¢« `useEffectEvent` åŒ…è£¹çš„å‡½æ•°ä¸æ˜¯å“åº”å¼çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†å“åº”å€¼shoppingCartï¼Œæ—¢å¯ä»¥åŠæ—¶æ‹¿åˆ°æœ€æ–°çš„è´­ç‰©è½¦ä¿¡æ¯ï¼Œåˆé¿å…äº†è´­ç‰©è½¦å˜åŒ–å¼•èµ·åŒ…è£¹onVisitå‡½æ•°çš„ç»„ä»¶çš„å˜åŒ–ã€‚

> P.S. ä»–çš„ä½¿ç”¨æ–¹å¼åŒ useEvent

## 4. useLayoutEffect

`useLayoutEffect` æ˜¯ `useEffect` çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚ä¸€èˆ¬ç”¨åœ¨æ§åˆ¶é¡µé¢æ¸²æŸ“çš„å·¥ä½œä¸­ï¼Œå…¶åœ¨é¡µé¢æ¸²æŸ“è¿‡ç¨‹ä¹‹å‰è°ƒç”¨ã€‚ï¼ˆä¼šå½±å“æ€§èƒ½ï¼‰

### ä½¿ç”¨åœºæ™¯

#### 1.é¡µé¢åˆå§‹åŒ–æ—¶è·å–çŸ©å½¢çš„é«˜åº¦

åœ¨å…ƒç´ æ¸²æŸ“ä¹‹å‰ï¼Œè·å–ä¸€ä¸ª ref æŒ‡å‘å…ƒç´ çš„é«˜åº¦ï¼Œå¹¶è®¾ç½®ç»™ç»„ä»¶çš„stateï¼š

```js
import { useState, useRef, useLayoutEffect } from 'react';

function Tooltip() {
  const ref = useRef(null);
  const [tooltipHeight, setTooltipHeight] = useState(0);

  useLayoutEffect(() => {
    const { height } = ref.current.getBoundingClientRect();
    setTooltipHeight(height);
  }, []);
  // ...
}
```

#### 2. åœ¨é¡µé¢é‡ç»˜ä¹‹å‰æ”¹åŠ¨å¸ƒå±€

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œtooltip ç»„ä»¶éœ€è¦åœ¨é¡µé¢æ¸²æŸ“æ—¶è·å–æŒ‚è½½å…ƒç´ çš„é«˜åº¦ï¼Œè¿›è€Œç¡®è®¤åœ¨å“ªä¸ªæ–¹å‘ä¸Šæ¸²æŸ“ï¼š

```js
useLayoutEffect(() => {
    const { height } = ref.current.getBoundingClientRect();
    setTooltipHeight(height);
    console.log('Measured tooltip height: ' + height);
  }, []);

  let tooltipX = 0;
  let tooltipY = 0;
  if (targetRect !== null) {
    tooltipX = targetRect.left;
    tooltipY = targetRect.top - tooltipHeight;
    if (tooltipY < 0) {
      // It doesn't fit above, so place below.
      tooltipY = targetRect.bottom;
    }
  }
  
  // ...
  
  return createPortal(
    <TooltipContainer x={tooltipX} y={tooltipY} contentRef={ref}>
      {children}
    </TooltipContainer>,
    document.body
  );
```
å®Œæ•´ä¾‹å­è§[å®˜ç½‘demo](https://codesandbox.io/s/bj8hpt?file=/TooltipContainer.js&utm_medium=sandpack)

### æ³¨æ„äº‹é¡¹

åœ¨ä½¿ç”¨react SSRæ—¶ï¼Œåˆå§‹çš„ HTMLæ¸²æŸ“ä¼šæ—©äº js è„šæœ¬ï¼Œä½†æ˜¯åœ¨æœåŠ¡ç«¯æ²¡æœ‰å¸ƒå±€ä¿¡æ¯ï¼Œæ‰€ä»¥åœ¨ js è„šæœ¬åŠ è½½å®Œæ¯•åï¼Œé¡µé¢å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œæ±‡æ€»å¦‚ä¸‹ï¼š

1.  ä¸ä¸€è‡´çš„æ¸²æŸ“ç»“æœï¼šç”±äºæœåŠ¡ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯æ¸²æŸ“çš„æ‰§è¡Œç¯å¢ƒä¸åŒï¼Œ`useLayoutEffect` åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¯èƒ½ä¼šäº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœã€‚è¿™å¯èƒ½å¯¼è‡´åœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶å‡ºç°é—ªçƒã€å¸ƒå±€é”™ä¹±æˆ–ä¸ç¬¦åˆé¢„æœŸçš„è¡Œä¸ºã€‚
2.  æ— æ•ˆçš„ DOM æ“ä½œï¼š`useLayoutEffect` åœ¨æœåŠ¡ç«¯æ‰§è¡Œæ—¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®åˆ°çœŸå®çš„ DOMã€‚å› æ­¤ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µå¯¹ DOM è¿›è¡Œçš„æ“ä½œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯æˆ–æ— æ•ˆçš„ç»“æœã€‚
3.  æ€§èƒ½é—®é¢˜ï¼šç”±äº `useLayoutEffect` çš„æ‰§è¡Œæ˜¯åŒæ­¥çš„ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªæ¸²æŸ“å‘¨æœŸéƒ½ä¼šè¢«è°ƒç”¨ï¼Œå¯èƒ½ä¼šå¯¹æœåŠ¡å™¨çš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚åœ¨å¤§è§„æ¨¡çš„ SSR é¡¹ç›®ä¸­ï¼Œé¢‘ç¹çš„åŒæ­¥ DOM æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™å’Œå“åº”æ—¶é—´å»¶é•¿ã€‚

> å»ºè®®ï¼šæœåŠ¡ç«¯æ¸²æŸ“çš„é¡¹ç›®ä¸­ä½¿ç”¨ `useEffect` æ›¿ä»£ï¼Œå¹¶ä½¿ç”¨ [`<Suspense>`](https://react.dev/reference/react/Suspense) æ‡’åŠ è½½ç»„ä»¶ï¼Œæˆ–è€…ä½¿ç”¨ hydration æ¨¡å¼å¼€å‘ã€‚

## 5. useInsertionEffect

`useInsertionEffect` æ˜¯ `useEffect` çš„ä¸€ä¸ªç‰ˆæœ¬ã€‚å…¶åœ¨ DOM å˜æ›´ä¹‹å‰è§¦å‘ï¼Œæ˜¯ä¸€ä¸ªç»“åˆ CSS-in-JS çš„æ ·å¼ä¿®æ”¹çš„è‡ªå®šä¹‰ hookã€‚

### ä½¿ç”¨åœºæ™¯

###### ä» CSS-in-JS åº“ä¸­æ’å…¥åŠ¨æ€æ ·å¼

åœ¨è¿è¡Œä¸­çš„ä»£ç ä¸­ï¼ŒåŠ¨æ€æ’å…¥ style æ ·å¼ï¼Œæœ‰ä¸¤ä¸ªå¼Šç«¯ï¼š

1. è¿«ä½¿æµè§ˆå™¨æ›´é¢‘ç¹åœ°é‡æ–°è®¡ç®—æ ·å¼ã€‚
2. å¦‚æœè¿è¡Œæ—¶æ³¨å…¥å‘ç”Ÿåœ¨ React ç”Ÿå‘½å‘¨æœŸçš„é”™è¯¯æ—¶é—´ï¼Œå®ƒå¯èƒ½ä¼šéå¸¸æ…¢ã€‚

ä½¿ç”¨ useInsertionEffect å¯ä»¥ä¸ºæˆ‘ä»¬æä¾›ä¸€ç§æ–¹æ¡ˆï¼Œè§£å†³ä¸Šé¢ç¬¬äºŒä¸ªé—®é¢˜ã€‚ï¼ˆç¬¬ä¸€ä¸ªé—®é¢˜ç›®å‰ä¸å¯è§£ï¼‰ï¼š

```js
let isInserted = new Set();
function useCSS(rule) {
  useInsertionEffect(() => {
    // As explained earlier, we don't recommend runtime injection of <style> tags.
    // But if you have to do it, then it's important to do in useInsertionEffect.
    if (!isInserted.has(rule)) {
      isInserted.add(rule);
      document.head.appendChild(getStyleForRule(rule));
    }
  });
  return rule;
}

function Button() {
  const className = useCSS('...');
  return <div className={className} />;
}
```

useInsertionEffect åŒæ ·ä¸é€‚ç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ï¼Œåœ¨ä¹¦å†™æ—¶éœ€è¦é¢å¤–åˆ¤æ–­ï¼š

```js
let collectedRulesSet = new Set();

function useCSS(rule) {
  if (typeof window === 'undefined') {
    collectedRulesSet.add(rule);
  }
  useInsertionEffect(() => {
    // ...
  });
  return rule;
}
```

> P.S. ä»–æ˜¯å¦‚ä½•è§£å†³ç¬¬äºŒæ¡é—®é¢˜çš„ï¼šå¦‚æœåœ¨æ¸²æŸ“æœŸé—´æ’å…¥æ ·å¼å¹¶ä¸” React æ­£åœ¨å¤„ç†éé˜»å¡æ›´æ–°ï¼Œåˆ™æµè§ˆå™¨å°†åœ¨æ¸²æŸ“ç»„ä»¶æ ‘æ—¶æ¯å¸§é‡æ–°è®¡ç®—æ ·å¼ï¼Œè¿™å¯èƒ½ä¼šéå¸¸æ…¢ã€‚useInsertionEffect æ¯”åœ¨ useLayoutEffect æˆ– useEffect ä¸­æ’å…¥æ ·å¼è¦å¥½ï¼Œå› ä¸ºå®ƒç¡®ä¿å½“å…¶ä»– Effects åœ¨ç»„ä»¶ä¸­è¿è¡Œæ—¶ï¼Œ\<style\> æ ‡ç­¾å·²ç»è¢«æ’å…¥ã€‚å¦åˆ™ï¼Œå¸¸è§„ Effects ä¸­çš„å¸ƒå±€è®¡ç®—å°†ç”±äºè¿‡æ—¶çš„æ ·å¼è€Œå‡ºé”™ã€‚

----

æœ¬æœŸå®Œäº†ï¼Œå€ºè§ï¼

# æ–°ç‰ˆReactå®˜æ–¹æ–‡æ¡£è§£è¯»ï¼ˆå…­ï¼‰- Hooks ä¹‹ useTransitionã€useDeferredValue
---

å®˜ç½‘åœ°å€ï¼š[React](https://react.dev/)


## 1. useTransition

useTransition å¯ä»¥è®©ä½ ä¸é˜»å¡ UI æ¸²æŸ“æ¥æ›´æ–° state çš„å€¼ã€‚å¯ä»¥ç†è§£ä¸ºå®ç°æ›´æµç•…çš„é¡µé¢è¿‡æ¸¡ã€‚ä½¿ç”¨æ–¹å¼ä¸ºï¼š

```js
// ä¸€ä¸ªåˆ‡æ¢ tab é¡µç­¾çš„ä¾‹å­
function TabContainer() {
  const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState('about');

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);
    });
  }
  // ...
}
```

å…¶ä¸­ï¼š

- isPendingï¼šä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºå½“å‰æ˜¯å¦é˜»å¡
- startTransitionï¼šå¼€å¯è¿‡æ¸¡ï¼Œå¹¶å¯ä¿®æ”¹ state

### æ³¨æ„äº‹é¡¹

- ä½œä¸ºä¸€ä¸ª hookï¼Œåªèƒ½åœ¨å‡½æ•°å¼ç»„ä»¶æˆ–è€…è‡ªå®šä¹‰ hook é‡Œè¢«è°ƒç”¨ï¼Œå¦‚æœæƒ³è¦å•ç‹¬ä½œä¸º API è°ƒç”¨ï¼Œå¯ä½¿ç”¨ [`startTransition`](https://react.dev/reference/react/startTransition)
- ä»…ä»…å¯ä»¥åœ¨ setState ä¸­è§¦å‘ï¼Œè‹¥æƒ³è¦åœ¨ props å˜åŒ–åè§¦å‘ï¼Œéœ€ä½¿ç”¨ [`useDeferredValue`](https://react.dev/reference/react/useDeferredValue)
- startTransition é‡Œçš„æ–¹æ³•ä¸èƒ½æœ‰å¼‚æ­¥å‡½æ•°ï¼Œè®¾ç½®å¼‚æ­¥ä¼šæ‰“ä¹±æ¸²æŸ“é¡ºåºï¼Œè¿™ä¸ªæ¸²æŸ“å°±å¤±å»ä½œç”¨äº†ã€‚
- æ ‡è®°ä¸º transition çš„ state ä¼šè¢«å…¶ä»– state çš„æ›´æ–°æ‰“æ–­ã€‚å¦‚æœæ‚¨åœ¨ transition ä¸­æ›´æ–°å›¾è¡¨ç»„ä»¶ï¼Œä½†åœ¨å›¾è¡¨å¤„äºé‡æ–°æ¸²æŸ“è¿‡ç¨‹ä¸­å¼€å§‹åœ¨å¦å¤–çš„ input ä¸­é”®å…¥è¾“å…¥ï¼Œåˆ™ React å°†åœ¨å¤„ç†è¾“å…¥æ›´æ–°åé‡æ–°å¯åŠ¨å›¾è¡¨ç»„ä»¶çš„æ¸²æŸ“å·¥ä½œã€‚
- ä¸èƒ½ç”¨äºæ§åˆ¶æ–‡æœ¬è¾“å…¥
- å¦‚æœæœ‰å¤šä¸ªæ­£åœ¨è¿›è¡Œçš„ transitionï¼ŒReact ç›®å‰ä¼šå°†å®ƒä»¬æ‰¹å¤„ç†åœ¨ä¸€èµ·ã€‚æ­¤åŠŸèƒ½å¯èƒ½ä¼šåœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤

### ä½¿ç”¨æ¡ˆä¾‹

1. åˆ‡æ¢ tab å¡é¡¿é—®é¢˜ï¼š

è¿™é‡Œæœ‰å‡ ä¸ªtabï¼Œtabå†…å®¹å¦‚ä¸‹ï¼š

```js
// tab 1 ä¸€ä¸ªæŒ‰é’®
<button onClick={() => {
  onClick();
}}>
  {children}
</button>

// tab 2 ä¸€ä¸ª p
return (
    <p>Welcome to my profile!</p>
);

// tab 3 ä¸€ä¸ªå¤æ‚åˆ—è¡¨
let items = [];
for (let i = 0; i < 500; i++) {
    items.push(<SlowPost key={i} index={i} />);
}
return (
    <ul className="items">
      {items}
    </ul>
);

function SlowPost({ index }) {
  let startTime = performance.now();
  while (performance.now() - startTime < 1) {
    // äººä¸ºæ¨¡æ‹Ÿçš„å¡é¡¿
  }

  return (
    <li className="item">
      Post #{index + 1}
    </li>
  );
}
```

å¯ä»¥çœ‹åˆ°ï¼Œtab3åŒ…å« 500 ä¸ªå…ƒç´ ï¼Œé¡µé¢æ¸²æŸ“åŠ¿å¿…ä¼šå¡é¡¿1-2ç§’ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ª tab åˆ‡æ¢ç»„ä»¶ï¼š

```js
export default function TabContainer() {
  const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState(1);

  function selectTab(nextTab) {
    setTab(nextTab);      
  }

  return (
    <>
      <TabButton
        isActive={tab === 1}
        onClick={() => selectTab(1)}
      >
        About
      </TabButton>
      ...
      <TabButton
        isActive={tab === 3}
        onClick={() => selectTab(3)}
      >
        Posts (slow)
      </TabButton>
      ...
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ï¼ŒTabButton æ˜¯ä¸€ä¸ªå…¬å…±å­ç»„ä»¶ï¼Œæ˜¯å‡ ä¸ªé¡¶éƒ¨çš„æŒ‰é’®ï¼Œç”¨äºæ¥å—äº‹ä»¶åˆ‡æ¢ tabï¼š

```js
<button onClick={() => {
  // è°ƒç”¨çˆ¶ç»„ä»¶TabContainerçš„ selectTab æ–¹æ³•
  onClick();
}}>
  {children}
</button>
```

Posts é¡µç­¾ï¼ˆtab3ï¼‰åœ¨ active çš„æ—¶å€™å°±ä¼šåŠ è½½æ¸²æŸ“ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹é¡µé¢çš„ååº”ï¼š


![image.png](/images/2023-8-18/2023-8-18-1.png)

æˆ‘ä»¬æ¥å…¥ useTransition è¯•è¯•ï¼š

```js
const [isPending, startTransition] = useTransition();
  const [tab, setTab] = useState('about');

  function selectTab(nextTab) {
    startTransition(() => {
      setTab(nextTab);      
    });
  }
```

å†æ¬¡åˆ‡æ¢ tab çœ‹çœ‹æ•ˆæœï¼š

![image.png](/images/2023-8-18/2023-8-18-2.png)

æˆªå›¾çœ‹çš„ä¸æ˜æ˜¾ï¼Œæˆ‘åœ¨å›¾ä¸ŠæŠŠæ•ˆæœç”¨æ–‡å­—æ ‡è¯†å‡ºæ¥äº†ã€‚ä¹Ÿå°±æ˜¯è¯´è·Ÿ startTransition ç›¸å…³çš„ state çš„å˜åŒ–å¼•èµ·çš„æ¸²æŸ“éƒ½ä¼šè¿›å…¥è¿‡æ¸¡ä¸­ã€‚

2. å­ç»„ä»¶æ›´æ”¹çˆ¶ç»„ä»¶ state

ä¸Šé¢çš„ä¾‹å­ï¼Œä½ ä¹Ÿå¯ä»¥å°†æ›´æ”¹ state çš„æ“ä½œæ”¾åœ¨å­ç»„ä»¶ä¸­ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬æ”¹å†™ tabButton ç»„ä»¶ï¼š

```js
<button onClick={() => {
  startTransition(() => {
    // è°ƒç”¨çˆ¶ç»„ä»¶TabContainerçš„ selectTab æ–¹æ³•
    onClick();
  });
}}>
  {children}
</button>
```
è€Œåœ¨çˆ¶ç»„ä»¶ä¸­ï¼Œå°±å¯ä»¥ç›´æ¥è®¾ç½® state äº†ï¼š

```js
function selectTab(nextTab) { 
  setTab(nextTab); 
}
```

3. é¡µé¢ä¸Šæ˜¾ç¤ºé˜»å¡æ¸²æŸ“æ—¶çš„è¿›åº¦

è¿™ä¸ªå°±æ˜¯ useTransition çš„è¿”å›å€¼ isPending çš„åº”ç”¨ï¼Œä»–ä¸º true æ—¶è¡¨ç¤ºè¿™ä¸ªè¿‡æ¸¡åŠ¨ç”»è¿˜åœ¨è¿›è¡Œä¸­ã€‚

```js
const [isPending, startTransition] = useTransition();
 
if (isPending) {
  return <b className="pending">{children}</b>;
}
```

4. ä¸ Suspends ç»“åˆï¼Œåšç»„ä»¶æ‡’åŠ è½½

æ²¿ç”¨ç¬¬äºŒä¸ªä¾‹å­çš„ä»£ç ï¼Œå­ç»„ä»¶tabButtonå®ç°useTransitionï¼Œæˆ‘ä»¬åªæ”¹çˆ¶ç»„ä»¶ï¼š

```js
<Suspense fallback={<h1>ğŸŒ€ Loading...</h1>}>
  <TabButton
    isActive={tab === 'about'}
    onClick={() => setTab('about')}
  >
    About
  </TabButton>
  ...
</Suspense>
```
è¿™æ ·åœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶å°±ä¼šå‡ºç° fallbackæç¤ºï¼š


![image.png](/images/2023-8-18/2023-8-18-3.png)

ä½¿ç”¨ Suspense çš„å¥½å¤„åœ¨äºï¼Œå¤æ‚ç»„ä»¶åªéœ€åŠ è½½ä¸€æ¬¡ï¼Œç¬¬äºŒæ¬¡åˆ‡æ¢åŠ è½½æ—¶å°±è¢«ç¼“å­˜äº†ï¼Œå¯ä»¥å¾ˆå¿«çš„æ¸²æŸ“.

5. è‡ªå®šä¹‰ä¸€ä¸ªè‡ªå·±çš„ react è·¯ç”±ï¼ï¼ˆå½“ç„¶ä¸æ˜¯çœŸçš„è·¯ç”±ï¼‰


æˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·å®šä¹‰ä¸€ä¸ª Router å‡½æ•°ï¼š

```js
function Router() {
  const [page, setPage] = useState('/');
  const [isPending, startTransition] = useTransition();

  function navigate(url) {
    startTransition(() => {
      setPage(url);
    });
  }

  let content;
  if (page === '/') {
    content = (
      <IndexPage navigate={navigate} />
    );
  } else if (page === '/the-beatles') {
    content = (
      <ArtistPage
        artist={{
          id: 'the-beatles',
          name: 'The Beatles',
        }}
      />
    );
  }
  return (
    <Layout isPending={isPending}>
      {content}
    </Layout>
  );
}
```
æ¥åˆ†æä¸€ä¸‹ï¼Œä¸Šé¢ Layout ç»„ä»¶æ˜¯è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œå†…éƒ¨ç›´æ¥æŠ›å‡º children å±æ€§å³å¯ï¼›ä¸Šé¢åˆ¤æ–­å½“å‰çš„çŠ¶æ€ page æ˜¯ `'/the-beatles'` å’Œ `'/'` æ—¶ï¼Œè‡ªåŠ¨æ¸²æŸ“ä¸åŒçš„ç»„ä»¶ï¼›å…¶ä¸­ï¼Œ`navigate` å‡½æ•°ç”¨äºå¯¼èˆªè·³è½¬ï¼Œä»–å…¶å®æ“ä½œçš„å°±æ˜¯ä¸€ä¸ªå¸¦ Transition çš„ setPageï¼Œè¿™æ ·å°±å®ç°äº†ä¸€ä¸ªå¹³æ»‘çš„è·¯ç”±åˆ‡æ¢ã€‚


### Q&A

1. ä¸ºå•¥æˆ‘çš„ input ä¸­ useTransition ä¸ç”Ÿæ•ˆï¼Ÿï¼Ÿ

å› ä¸ºä½ è¯•å›¾ç”¨ä»–æ¥æ§åˆ¶è¾“å…¥æ¡†ï¼Œè¿™æ˜¯ä¸æ”¯æŒçš„ï¼š

```js
const [text, setText] = useState('');
// ...
function handleChange(e) {
  // âŒ Can't use transitions for controlled input state
  startTransition(() => {
    setText(e.target.value);
  });
}
// ...
return <input value={text} onChange={handleChange} />;
```
è¿™æ˜¯å› ä¸º useTransition æ˜¯éé˜»å¡æ¸²æŸ“çš„ï¼Œä½†æ˜¯è¾“å…¥æ¡†æ¯”è¾ƒç‰¹æ®Šï¼Œä»–çš„ change äº‹ä»¶å¿…é¡»æ˜¯åŒæ­¥æ›´æ–°çš„ï¼Œå¦‚æœä½ éè¦ä½¿ç”¨å¹³æ»‘è¿‡æ¸¡æ¥æ§åˆ¶è¾“å…¥ç»„ä»¶ï¼Œæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š

- å®šä¹‰ä¸¤ä¸ª stateï¼Œä¸€ä¸ªç”¨äºæ§åˆ¶è¾“å…¥ï¼Œä¸€ä¸ªç”¨äºç›‘å¬è¾“å…¥å€¼å˜åŒ–ååŒæ­¥æ›´æ–°
- ä½¿ç”¨ [`useDeferredValue`](https://react.dev/reference/react/useDeferredValue) æ¥ä»£æ›¿

2. æˆ‘çš„ state å˜åŒ–ä¼¼ä¹æ²¡æœ‰å®ç°è¿‡æ¸¡ï¼Œè¿˜æ˜¯è¢«é˜»å¡äº†ï¼Ÿ

å› ä¸ºä½ åœ¨ startTransition ä½¿ç”¨å¼‚æ­¥äº†ï¼š

```js
// æ¡ˆä¾‹1
startTransition(() => {
  // âŒ Setting state *after* startTransition call
  setTimeout(() => {
    setPage('/about');
  }, 1000);
});

// æ¡ˆä¾‹2
startTransition(async () => {
  await someAsyncFunction();
  // âŒ Setting state *after* startTransition call
  setPage('/about');
});
```
å¦‚æœéå¾—ä½¿ç”¨ setTimeoutï¼Œå¯ä»¥è¿™æ ·ï¼š

```js
// æ¡ˆä¾‹1
setTimeout(() => {
  startTransition(() => {
    // âœ… Setting state *during* startTransition call
    setPage('/about');
  });
}, 1000);

// æ¡ˆä¾‹2
await someAsyncFunction();
startTransition(() => {
  // âœ… Setting state *during* startTransition call
  setPage('/about');
});
```

3. æˆ‘çš„ä»£ç æ‰§è¡Œé¡ºåºä¸å¤ªå¯¹ï¼šit will print 1, 2, 3:

```js
console.log(1);
startTransition(() => {
  console.log(2);
  setPage('/about');
});
console.log(3);
```
ä½†æ˜¯ï¼Œ1 2 3 å°±åº”è¯¥æ˜¯æœŸæœ›çš„é¡ºåºï¼Œä¸åŒäº setTimeoutï¼ŒstartTransition è¿˜æ˜¯ç«‹å³æ‰§è¡Œå‡½æ•°çš„ï¼Œåªæ˜¯æ¸²æŸ“ä¸åŒæ­¥è€Œå·²ï¼Œä»–çš„ç®€å•å®ç°ç±»ä¼¼äºï¼š

```js
let isInsideTransition = false;

function startTransition(scope) {
  isInsideTransition = true;
  scope();
  isInsideTransition = false;
}

function setState() {
  if (isInsideTransition) {
    // ... schedule a transition state update ...
  } else {
    // ... schedule an urgent state update ...
  }
}
```
å…¶å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ isInsideTransition = trueï¼Œåœ¨æ‰§è¡Œå®Œå›è°ƒå‡½æ•°åï¼Œç½®ä¸º falseï¼›è®¾ç½® state æ—¶åˆ¤æ–­ä¸º true æ—¶è¡¨ç¤ºåœ¨è¿‡æ¸¡ä¸­ï¼Œæ­¤æ—¶æ‰§è¡Œè¿‡æ¸¡çš„æ“ä½œã€‚æ‰€ä»¥å¯ä»¥çœ‹åˆ°ï¼Œä»–å¹¶ä¸é˜»å¡ scope çš„æ‰§è¡Œã€‚


## 2. useDeferredValue

ä¸€ä¸ªå¯ä»¥è®©ä½ å»¶è¿Ÿï¼ˆdeferï¼‰æ›´æ–°UIçš„ hookã€‚

- æ¥æ”¶å‚æ•° valueï¼šä½ æƒ³è¦å»¶è¿Ÿçš„å€¼ï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ã€‚
- è¿”å›å€¼ï¼šåœ¨åˆå§‹æ¸²æŸ“æœŸé—´ï¼Œè¿”å›çš„å»¶è¿Ÿå€¼å°†ä¸ä½ æä¾›çš„å€¼ç›¸åŒã€‚åœ¨æ›´æ–°æœŸé—´ï¼ŒReact å°†é¦–å…ˆå°è¯•ä½¿ç”¨æ—§å€¼é‡æ–°æ¸²æŸ“ï¼ˆå› æ­¤å®ƒå°†è¿”å›æ—§å€¼ï¼‰ï¼Œç„¶åå°è¯•ä½¿ç”¨æ–°å€¼åœ¨åå°é‡æ–°æ¸²æŸ“ï¼ˆå› æ­¤å®ƒå°†è¿”å›æ›´æ–°çš„å€¼ï¼‰ã€‚

### ä½¿ç”¨æ¡ˆä¾‹

1. å¼¥è¡¥useTransitionä¸è¶³ï¼šç›‘å¬inputè¾“å…¥å¹¶å¹³æ»‘è¿‡æ¸¡

```js
import { Suspense, useState } from 'react';
import SearchResults from './SearchResults.js';

export default function App() {
  const [query, setQuery] = useState('');
  const deferredQuery = useDeferredValue(query);
  
  return (
    <>
      <label>
        Search albums:
        <input value={query} onChange={e => setQuery(e.target.value)} />
      </label>
      <Suspense fallback={<h2>Loading...</h2>}>
        <SearchResults query={deferredQuery} />
      </Suspense>
    </>
  );
}
```
ä¸Šé¢çš„ä¾‹å­ï¼Œæ¯å½“è¾“å…¥æ¡†è¾“å…¥æ—¶ï¼ŒSuspense çš„ fallback å°†ä¸å†æ¸²æŸ“ï¼Œè€Œæ˜¯ç›´æ¥å¹³æ»‘è¿‡æ¸¡æ˜¾ç¤ºæœ€æ–°çš„å€¼ï¼Œè¿™å°±ä½¿å¾—æ˜¾ç¤ºæ›´åŠ ç¨³å®šï¼Œä¸ä¼šæŠ–åŠ¨ã€‚


![image.png](/images/2023-8-18/2023-8-18-4.png)

ä¸Šå›¾ä¸­ï¼Œè¾“å…¥å€¼ï¼Œè¾“å…¥æ¡†ç«‹é©¬å˜åŒ–ï¼Œä¸‹é¢æ˜¾ç¤ºåŒºåŸŸæ¼”ç¤ºå˜åŒ–ï¼Œä½†ä¸ä¼šæ˜¾ç¤º fallback çš„ loadingã€‚

2. æ·»åŠ æ¸²æŸ“è¿‡åº¦åŠ¨ç”»

åœ¨ä¸Šé¢ä¾‹å­çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ ä¸€ä¸ªé€æ˜æ•ˆæœï¼š

```js
 // æ—§å€¼å’Œæ–°å€¼ä¸ä¸€æ ·ï¼Œè¡¨ç¤ºåœ¨è¿‡æ¸¡ä¸­ï¼Œè¿‡æ¸¡å®Œæ¯•å query ä¼šå˜ä¸ºä¸ deferredQuery ä¸€æ ·
 const isStale = query !== deferredQuery;
 ...
 <Suspense fallback={<h2>Loading...</h2>}>
    <div style={{
      opacity: isStale ? 0.5 : 1,
      transition: isStale ? 'opacity 0.2s 0.2s linear' : 'opacity 0s 0s linear'
    }}>
      <SearchResults query={deferredQuery} />
    </div>
</Suspense>
```
å¦‚å›¾ï¼Œåœ¨è¾“å…¥è¿‡ç¨‹ä¸­ï¼Œç»“æœæ–‡å­—å˜ä¸ºåŠé€æ˜ï¼š

![image.png](/images/2023-8-18/2023-8-18-5.png)

3. ä¼˜åŒ–é•¿åˆ—è¡¨æ¸²æŸ“

SlowList å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè‚¥è‚ å¤šæ•°æ®çš„é•¿åˆ—è¡¨ï¼Œæ¯ä¸€ä¸ªåˆ—è¡¨éƒ½æœ‰ä¸€ä¸ªå…¬å…±çš„å€¼è¦æ§åˆ¶ï¼Œå«åš deferredTextï¼Œæˆ‘ä»¬è¿™æ ·å®ç°ï¼š

```js
export default function App() {
  const [text, setText] = useState('');
  const deferredText = useDeferredValue(text);
  return (
    <>
      <input value={text} onChange={e => setText(e.target.value)} />
      <SlowList text={deferredText} />
    </>
  );
}

```
è¿™æ ·è¿‡æ¸¡æ˜¯å°±ä¸ä¼šå‡ºç°çŸ­æ—¶é—´ç•Œé¢å¡é¡¿ä¸å¯äº¤äº’çš„æƒ…å†µï¼Œä¸ç„¶å°±ä¼šè¿™æ ·ï¼š

![image.png](/images/2023-8-18/2023-8-18-6.png)

ä¸Šå›¾ä¸ä½¿ç”¨useDeferredValueï¼Œæ²¡è¾“å…¥ä¸€ä¸‹ï¼Œå°±ä¼šå¡ä¸€ä¸‹ï¼Œé¡µé¢é˜»å¡ã€‚ä½¿ç”¨äº† useDeferredValue å°±ä¼šä¸€æ­¥æ¸²æŸ“ï¼Œä¸ä¼šé˜»å¡ä½ è¾“å…¥å•¦ï¼å¯ä»¥å»å®˜ç½‘ä¾‹å­è¯•è¯•ï¼š[codesandbox.io/s/r6hcz2?file=%2FApp.js&utm_medium=sandpack](https://codesandbox.io/s/r6hcz2?file=%2FApp.js&utm_medium=sandpack)

> `SlowList` ç»„ä»¶åº”è¯¥æ”¾åœ¨ memo é‡Œï¼Œä¸ç„¶ä¼˜åŒ–ä¼šå¤±æ•ˆã€‚æ¯æ¬¡deferredTextå˜åŒ–æ—¶ï¼ŒAppç»„ä»·ç”±äºçŠ¶æ€å˜åŒ–äº†ï¼Œä¼šé‡æ–°æ¸²æŸ“ï¼Œå¯¼è‡´ SlowList å˜ä¸ºäº†æ–°çš„ç»„ä»¶äº†ã€‚

-----
å®Œï¼